import { Button, VerticalBox, HorizontalBox, ScrollView, LineEdit, ComboBox } from "std-widgets.slint";

export struct ProxyData {
    name: string,
    host: string,
    port: string,
    protocol: string,
}

export struct TrafficEntry {
    process_name: string,
    target: string,
    time: string,
    rule_proxy: string,
    sent: string,
    received: string,
    src_port: string,
}

export struct RuleData {
    name: string,
    process_name: string, // empty means None
    target_ips: string,    // comma separated
    target_ports: string,  // comma separated
    protocol: string,      // "TCP", "UDP", "Both"
    action: string,        // "Proxy", "Direct", "Block"
    proxy_name: string,    // Selection for Proxy action
    enabled: bool,
}

export component AppWindow inherits Window {
    title: "ProxyBridge High Performance Rust";
    icon: @image-url("../icon.ico");
    min-width: 1000px;
    min-height: 700px;
    background: #1a1a2e;
    
    // States
    in property <bool> is-running: false;
    in property <string> status-text: "System Ready";
    in property <int> active-connections: 0;
    in property <[TrafficEntry]> traffic-rows: [];
    
    // Rules State
    in property <[RuleData]> rules-list: [];
    in property <[ProxyData]> proxies-list: [];
    in property <[string]> proxy-names: []; // Derived helper
    
    // Current Rule Editing (for Adding)
    property <string> new-rule-name: "";
    property <string> new-rule-proc: "";
    property <string> new-rule-ips: "";
    property <string> new-rule-ports: "";
    property <string> new-rule-proto: "Both";
    property <string> new-rule-action: "Proxy";
    property <string> new-rule-proxy: "Default";

    // New Proxy Editing
    property <string> new-proxy-name: "";
    property <string> new-proxy-host: "";
    property <string> new-proxy-port: "";
    property <string> new-proxy-proto: "socks5";

    // List Indices for editing
    property <int> edit-rule-idx: -1;
    property <int> edit-proxy-idx: -1;

    // Configuration Properties (Bound to Rust)
    in-out property <bool> fake-ip-enabled: true;
    in-out property <bool> logging-enabled: true;
    in-out property <bool> monitor-enabled: true;
    in-out property <string> default-rule-action: "Direct";
    
    callback toggle-proxy();
    callback default-rule-changed(string);
    callback save-config(bool, bool, bool);
    callback toggle-rule-enabled(int, bool);
    callback add-rule(RuleData);
    callback remove-rule(int);
    callback update-rule(int, RuleData);
    callback add-proxy(ProxyData);
    callback remove-proxy(int);
    callback update-proxy(int, ProxyData);

    VerticalBox {
        padding: 20px;
        spacing: 20px;

        // --- DASHBOARD HEADER ---
        Rectangle {
            height: 85px;
            background: #1a1a2e;
            border-radius: 12px;
            border-width: 1px;
            border-color: #34495e;

            HorizontalBox {
                padding: 15px; spacing: 25px;
                
                // App Logo and Start Button
                HorizontalBox {
                    width: 260px; spacing: 15px;
                    Text { text: "ProxyBridge"; font-size: 24px; color: #e94560; font-weight: 800; vertical-alignment: center; }
                    Button {
                        text: is-running ? "STOP" : "START";
                        primary: !is-running;
                        width: 85px;
                        clicked => { root.toggle-proxy() }
                    }
                }

                // Stats and Controls
                HorizontalBox {
                    horizontal-stretch: 1; spacing: 40px;
                    
                    VerticalBox { alignment: center; Text { text: "ACTIVE CONNS"; color: #95a5a6; font-size: 10px; font-weight: 700; } Text { text: active-connections; color: white; font-size: 22px; font-weight: 700; } }
                    VerticalBox { alignment: center; Text { text: "SYSTEM STATUS"; color: #95a5a6; font-size: 10px; font-weight: 700; } Text { text: status-text; color: is-running ? #2ecc71 : #f1c40f; font-size: 16px; font-weight: 600; } }
                    
                    HorizontalBox {
                        spacing: 12px; alignment: center;
                        Text { text: "DNS SOLVING"; color: #95a5a6; vertical-alignment: center; font-size: 11px; font-weight: 700; }
                        HorizontalBox {
                            spacing: 8px; alignment: center;
                            Text { text: "Remote"; color: !fake-ip-enabled ? white : #5d6d7e; font-size: 12px; font-weight: 600; vertical-alignment: center; height: 22px; }
                            Rectangle {
                                width: 44px; height: 22px; background: fake-ip-enabled ? #27ae60 : #34495e; border-radius: 11px;
                                TouchArea { clicked => { fake-ip-enabled = !fake-ip-enabled; root.save-config(fake-ip-enabled, logging-enabled, monitor-enabled); } }
                                Rectangle {
                                    x: fake-ip-enabled ? 24px : 2px; y: 2px; width: 18px; height: 18px; background: white; border-radius: 9px;
                                    animate x { duration: 150ms; }
                                }
                            }
                            Text { text: "Local"; color: fake-ip-enabled ? white : #5d6d7e; font-size: 12px; font-weight: 600; vertical-alignment: center; height: 22px; }
                        }
                    }
                    
                    HorizontalBox {
                        spacing: 12px; alignment: center;
                        Text { text: "LOGS"; color: #95a5a6; vertical-alignment: center; font-size: 11px; font-weight: 700; }
                        Rectangle {
                            width: 34px; height: 18px; background: logging-enabled ? #27ae60 : #34495e; border-radius: 9px;
                            TouchArea { clicked => { logging-enabled = !logging-enabled; root.save-config(fake-ip-enabled, logging-enabled, monitor-enabled); } }
                            Rectangle {
                                x: logging-enabled ? 18px : 2px; y: 2px; width: 14px; height: 14px; background: white; border-radius: 7px;
                                animate x { duration: 150ms; }
                            }
                        }
                    }

                    HorizontalBox {
                        spacing: 12px; alignment: center;
                        Text { text: "MONITOR"; color: #95a5a6; vertical-alignment: center; font-size: 11px; font-weight: 700; }
                        Rectangle {
                            width: 34px; height: 18px; background: monitor-enabled ? #27ae60 : #34495e; border-radius: 9px;
                            TouchArea { clicked => { monitor-enabled = !monitor-enabled; root.save-config(fake-ip-enabled, logging-enabled, monitor-enabled); } }
                            Rectangle {
                                x: monitor-enabled ? 18px : 2px; y: 2px; width: 14px; height: 14px; background: white; border-radius: 7px;
                                animate x { duration: 150ms; }
                            }
                        }
                    }

                    Button {
                        text: "Save Config"; height: 38px;
                        clicked => { root.save-config(fake-ip-enabled, logging-enabled, monitor-enabled) }
                    }
                }
            }
        }

        // --- MIDDLE SECTION: Nodes & Rules ---
        HorizontalBox {
            spacing: 20px;
            height: 420px;

            // Proxy Nodes Card
            Rectangle {
                width: 450px;
                background: #16213e;
                border-radius: 12px;
                border-width: 1px;
                border-color: #34495e;

                VerticalBox {
                    padding: 15px; spacing: 15px;
                    Text { text: "PROXY NODES"; color: #e94560; font-size: 12px; font-weight: 800; }
                    
                    // Add Node Form
                    VerticalBox {
                        spacing: 8px;
                        HorizontalBox {
                            spacing: 8px; height: 32px;
                            LineEdit { text <=> new-proxy-name; placeholder-text: "Node Name"; font-size: 11px; horizontal-stretch: 1; }
                            LineEdit { text <=> new-proxy-host; placeholder-text: "Host / IP"; font-size: 11px; horizontal-stretch: 1.5; }
                        }
                        HorizontalBox {
                            spacing: 8px; height: 32px;
                            LineEdit { text <=> new-proxy-port; placeholder-text: "Port"; horizontal-stretch: 1; font-size: 11px; }
                            ComboBox { model: ["socks5", "http", "https"]; current-value <=> new-proxy-proto; horizontal-stretch: 1.5; }
                        }
                    }
                    Button {
                        text: edit-proxy-idx < 0 ? "Add New Proxy Node" : "Update Selected Node"; 
                        primary: true; height: 34px;
                        clicked => {
                            if (edit-proxy-idx < 0) {
                                root.add-proxy({ name: new-proxy-name, host: new-proxy-host, port: new-proxy-port, protocol: new-proxy-proto });
                            } else {
                                root.update-proxy(edit-proxy-idx, { name: new-proxy-name, host: new-proxy-host, port: new-proxy-port, protocol: new-proxy-proto });
                                edit-proxy-idx = -1;
                            }
                            new-proxy-name = ""; new-proxy-host = ""; new-proxy-port = ""; new-proxy-proto = "socks5";
                        }
                    }

                    Rectangle { height: 1px; background: #34495e; }

                    // Scrollable List
                    Rectangle {
                        background: #0f3460; border-radius: 8px; vertical-stretch: 1; clip: true;
                        ScrollView {
                            VerticalBox {
                                padding: 8px; spacing: 8px;
                                for p[idx] in proxies-list : Rectangle {
                                    height: 50px; background: #16213e; border-radius: 6px;
                                        HorizontalBox {
                                            padding-left: 12px; padding-right: 12px;
                                            VerticalBox {
                                                alignment: center; horizontal-stretch: 1;
                                                Text { text: p.name; color: white; font-weight: 700; font-size: 13px; overflow: elide; }
                                                Text { text: p.protocol + "://" + p.host + ":" + p.port; color: #95a5a6; font-size: 11px; }
                                            }
                                            HorizontalBox {
                                                spacing: 6px; alignment: end;
                                                Button { text: "Edit"; width: 45px; height: 26px; clicked => { new-proxy-name = p.name; new-proxy-host = p.host; new-proxy-port = p.port; new-proxy-proto = p.protocol; edit-proxy-idx = idx; } }
                                                Button { text: "Del"; width: 45px; height: 26px; clicked => { root.remove-proxy(idx) } }
                                            }
                                        }
                                }
                            }
                        }
                    }
                }
            }

            // Rules Card
            Rectangle {
                horizontal-stretch: 1;
                background: #16213e;
                border-radius: 12px;
                border-width: 1px;
                border-color: #34495e;

                VerticalBox {
                    padding: 15px; spacing: 15px;
                    Text { text: "TRAFFIC ROUTING RULES"; color: #e94560; font-size: 12px; font-weight: 800; }
                    
                    HorizontalBox {
                        spacing: 15px; alignment: start;
                        Text { text: "DEFAULT ACTION (if no rule matches):"; color: #bdc3c7; font-size: 11px; vertical-alignment: center; }
                        ComboBox { 
                            model: ["Direct", "Proxy"]; 
                            current-value <=> default-rule-action; 
                            width: 100px; 
                            selected => { root.default-rule-changed(self.current-value) }
                        }
                    }
                    
                    // Add Rule Form
                    VerticalBox {
                        spacing: 8px;
                        HorizontalBox {
                            spacing: 8px; height: 32px;
                            LineEdit { text <=> new-rule-name; placeholder-text: "Name"; font-size: 11px; horizontal-stretch: 1; }
                            LineEdit { text <=> new-rule-proc; placeholder-text: "Process (opt)"; font-size: 11px; horizontal-stretch: 1.5; }
                            LineEdit { text <=> new-rule-ips; placeholder-text: "IPs (opt)"; font-size: 11px; horizontal-stretch: 1.5; }
                            LineEdit { text <=> new-rule-ports; placeholder-text: "Ports"; width: 70px; font-size: 11px; }
                        }
                        HorizontalBox {
                            spacing: 8px; height: 32px;
                            ComboBox { model: ["Both", "TCP", "UDP"]; current-value <=> new-rule-proto; width: 85px; }
                            ComboBox { model: ["Proxy", "Direct", "Block"]; current-value <=> new-rule-action; width: 95px; }
                            if (new-rule-action == "Proxy") : ComboBox { model: proxy-names; current-value <=> new-rule-proxy; }
                            Rectangle { horizontal-stretch: 1; }
                            Button {
                                text: edit-rule-idx < 0 ? "Add Routing Rule" : "Update Rule"; 
                                primary: true; width: 150px; height: 32px;
                                clicked => {
                                    if (edit-rule-idx < 0) {
                                        root.add-rule({ name: new-rule-name, process_name: new-rule-proc, target_ips: new-rule-ips, target_ports: new-rule-ports, protocol: new-rule-proto, action: new-rule-action, proxy_name: new-rule-proxy, enabled: true });
                                    } else {
                                        root.update-rule(edit-rule-idx, { name: new-rule-name, process_name: new-rule-proc, target_ips: new-rule-ips, target_ports: new-rule-ports, protocol: new-rule-proto, action: new-rule-action, proxy_name: new-rule-proxy, enabled: rules-list[edit-rule-idx].enabled });
                                        edit-rule-idx = -1;
                                    }
                                    new-rule-name = ""; new-rule-proc = ""; new-rule-ips = ""; new-rule-ports = "";
                                }
                            }
                        }
                    }

                    Rectangle { height: 1px; background: #34495e; }

                    // Rules List
                    Rectangle {
                        background: #0f3460; border-radius: 8px; vertical-stretch: 1; clip: true;
                        VerticalBox {
                            padding: 0px; spacing: 0px;
                            Rectangle {
                                height: 32px; background: #1a1a2e;
                                HorizontalBox {
                                    padding-left: 15px; padding-right: 15px;
                                    Text { text: "ENABLE"; color: #95a5a6; width: 60px; font-size: 10px; font-weight: 800; }
                                    Text { text: "RULE NAME"; color: #95a5a6; width: 120px; font-size: 10px; font-weight: 800; }
                                    Text { text: "MATCH CONDITION"; color: #95a5a6; horizontal-stretch: 1; font-size: 10px; font-weight: 800; }
                                    Text { text: "ACTION"; color: #95a5a6; width: 110px; font-size: 10px; font-weight: 800; }
                                    Text { text: "OPERATIONS"; color: #95a5a6; width: 130px; font-size: 10px; font-weight: 800; horizontal-alignment: right; }
                                }
                            }
                            ScrollView {
                                VerticalBox {
                                    alignment: start; padding: 8px; spacing: 6px;
                                    for r[idx] in rules-list : Rectangle {
                                        height: 48px; background: #16213e; border-radius: 6px;
                                        HorizontalBox {
                                            padding-left: 15px; padding-right: 15px;
                                            Rectangle {
                                                width: 60px;
                                                HorizontalBox {
                                                    alignment: start;
                                                    Rectangle {
                                                        width: 32px; height: 18px; background: r.enabled ? #27ae60 : #34495e; border-radius: 9px;
                                                        TouchArea { clicked => { root.toggle-rule-enabled(idx, !r.enabled); } }
                                                        Rectangle {
                                                            x: r.enabled ? 16px : 2px; y: 2px; width: 14px; height: 14px; background: white; border-radius: 7px;
                                                            animate x { duration: 150ms; }
                                                        }
                                                    }
                                                }
                                            }
                                            Text { text: r.name; color: r.enabled ? white : #5d6d7e; vertical-alignment: center; width: 120px; font-size: 12px; font-weight: 600; overflow: elide; }
                                            Text { text: (r.process_name != "" ? "Proc: " + r.process_name : "") + (r.target_ips != "" ? " IP: " + r.target_ips : "") + " (" + r.protocol + ")"; color: r.enabled ? #bdc3c7 : #4a5a6a; vertical-alignment: center; horizontal-stretch: 1; font-size: 11px; overflow: elide; }
                                            Text { text: r.action == "Proxy" ? r.proxy-name : r.action; color: r.enabled ? (r.action == "Proxy" ? #2ecc71 : (r.action == "Direct" ? #3498db : #e74c3c)) : #4a5a6a; vertical-alignment: center; width: 110px; font-size: 12px; font-weight: 700; overflow: elide; }
                                            HorizontalBox {
                                                width: 130px; spacing: 8px; alignment: end;
                                                Button { text: "Edit"; width: 55px; height: 28px; clicked => { new-rule-name = r.name; new-rule-proc = r.process_name; new-rule-ips = r.target_ips; new-rule-ports = r.target_ports; new-rule-proto = r.protocol; new-rule-action = r.action; new-rule-proxy = r.proxy-name; edit-rule-idx = idx; } }
                                                Button { text: "Del"; width: 50px; height: 28px; clicked => { root.remove-rule(idx) } }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        // --- BOTTOM SECTION: Traffic Monitor Card ---
        if (monitor-enabled) : Rectangle {
            vertical-stretch: 1;
            background: #16213e;
            border-radius: 12px;
            border-width: 1px;
            border-color: #34495e;

            VerticalBox {
                padding: 15px; spacing: 10px;
                Text { text: "LIVE REAL-TIME TRAFFIC MONITOR"; color: #e94560; font-size: 12px; font-weight: 800; }
                
                Rectangle {
                    background: #0f3460; border-radius: 8px; clip: true; vertical-stretch: 1;
                    VerticalBox {
                        padding: 0px; spacing: 0px;
                        Rectangle {
                            height: 32px; background: #1a1a2e;
                            HorizontalBox {
                                padding-left: 20px; padding-right: 20px;
                                Text { text: "Application"; color: #95a5a6; font-weight: 800; width: 18%; font-size: 10px; }
                                Text { text: "Target"; color: #95a5a6; font-weight: 800; width: 32%; font-size: 10px; }
                                Text { text: "Time/Status"; color: #95a5a6; font-weight: 800; width: 10%; font-size: 10px; }
                                Text { text: "Rule : Proxy"; color: #95a5a6; font-weight: 800; width: 20%; font-size: 10px; }
                                Text { text: "Sent"; color: #95a5a6; font-weight: 800; width: 10%; font-size: 10px; }
                                Text { text: "Received"; color: #95a5a6; font-weight: 800; width: 10%; font-size: 10px; }
                            }
                        }
                        ScrollView {
                            VerticalBox {
                                alignment: start; padding: 10px; spacing: 5px;
                                for entry in traffic-rows : Rectangle {
                                    height: 32px; background: #16213e; border-radius: 4px;
                                    HorizontalBox {
                                        padding-left: 15px; padding-right: 15px;
                                        Text { text: entry.process_name; color: #ecf0f1; vertical-alignment: center; width: 18%; overflow: elide; font-size: 12px; }
                                        Text { text: entry.target; color: #f1c40f; vertical-alignment: center; width: 32%; font-size: 12px; font-weight: 500; overflow: elide; }
                                        Text { text: entry.time; color: #bdc3c7; vertical-alignment: center; width: 10%; font-size: 12px; }
                                        Text { text: entry.rule_proxy; color: #3498db; vertical-alignment: center; width: 20%; font-size: 12px; overflow: elide; }
                                        Text { text: entry.sent; color: #2ecc71; vertical-alignment: center; width: 10%; font-size: 12px; font-weight: 600; }
                                        Text { text: entry.received; color: #e67e22; vertical-alignment: center; width: 10%; font-size: 12px; font-weight: 600; }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
